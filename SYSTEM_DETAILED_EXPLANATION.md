# 📘 자동매매 시스템 상세 설명서 (초보자 및 개발자 겸용)

## 1. 시스템 아키텍처 및 개요 (System Overview)

이 시스템은 **"24시간 쉬지 않고 주식과 코인을 대신 사고팔아주는 로봇"**입니다.
사용자가 전략(언제 살지, 언제 팔지)을 정해주면, 로봇이 거래소(업비트, 바이낸스 등)를 계속 감시하다가 조건이 맞을 때 자동으로 주문을 넣습니다.

### 1.1 전체 구조도 (어떻게 연결되어 있나요?)

시스템은 크게 4가지 부품으로 이루어져 있습니다.

1.  **대시보드 (`dashboard.py`)**: **리모컨**입니다. 현재 자산이 얼마인지 보고, 전략을 바꾸거나 봇을 끄고 켤 수 있습니다.
2.  **메인 엔진 (`main.py`)**: **로봇의 몸체**입니다. 실제로 일을 하는 곳입니다. 대시보드의 명령을 듣고, 거래소에 주문을 보냅니다.
3.  **전략 두뇌 (`strategy.py`)**: **로봇의 뇌**입니다. "지금 살까? 말까?"를 계산합니다.
4.  **데이터 저장소 (`data/`)**: **로봇의 수첩**입니다. 내가 뭘 샀는지, 얼마에 샀는지 적어두는 곳입니다.

```mermaid
graph TD
    User[사용자] -->|1. 화면 보고 조작| Dashboard[대시보드 (dashboard.py)]
    
    Dashboard -->|2. 명령 내림 (파일로 저장)| CommandJSON[명령 파일 (data/command.json)]
    Dashboard <--|3. 상태 확인 (파일 읽기)| StatusJSON[상태 파일 (data/bot_status.json)]
    
    Main[메인 로봇 (main.py)] -->|4. 명령 확인| CommandJSON
    Main -->|5. 상태 기록| StatusJSON
    
    Main -->|6. 가격 조회 & 주문| Exchange[거래소 (업비트/바이낸스)]
    Main -->|7. 살까 말까 질문| Strategy[전략 두뇌 (trading/strategy.py)]
    
    Strategy -->|8. 매수/매도 신호| Main
```

---

## 2. 데이터 및 파라미터 흐름 (설정은 어떻게 바뀌나요?)

로봇이 어떻게 설정을 읽고 행동을 바꾸는지 설명합니다.

### 2.1 설정이 적용되는 과정
1.  **시작할 때**: 로봇을 켜면 `config/settings.py`와 `.env` 파일(비밀번호 파일)을 읽어서 기억합니다.
2.  **실행 중에 바꿀 때**:
    *   **파일 수정**: 사용자가 `.env` 파일을 메모장으로 열어서 `CRYPTO_K_VALUE=0.5` 처럼 숫자를 바꾸고 저장하면, 로봇이 "어? 파일이 바뀌었네?" 하고 알아채서 즉시 새로운 값을 적용합니다. (이걸 **Hot Reload**라고 합니다.)
    *   **대시보드 버튼**: 대시보드에서 '전략 변경' 버튼을 누르면 `data/command.json`이라는 파일에 쪽지를 남깁니다. 로봇은 3초마다 이 쪽지함을 확인하다가 쪽지가 있으면 전략을 바꿉니다.

### 2.2 데이터 저장 방식 (꺼져도 기억하는 이유)
로봇은 컴퓨터가 꺼지거나 프로그램이 종료되어도 내가 뭘 가지고 있는지 잊어버리면 안 됩니다. 그래서 **JSON 파일**이라는 텍스트 파일에 장부를 기록합니다.

*   **`data/crypto_portfolio.json` (자산 장부)**:
    *   `positions`: "비트코인 0.5개, 이더리움 10개 가지고 있음"
    *   `entry_prices`: "비트코인은 5천만원에 샀고, 이더리움은 300만원에 샀음" (평단가)
    *   이 파일이 지워지면 로봇은 "나는 아무것도 안 가지고 있다"고 생각하게 되므로 **절대 지우면 안 됩니다.**

---

## 3. 핵심 프로그램 상세 분석 (로봇 해부)

### 3.1 메인 엔진 (`main.py`) - 로봇의 하루 일과

이 파일이 실행되면 로봇은 아래 행동을 무한히 반복합니다. (`monitor_and_trade` 함수)

1.  **준비 운동 (Warm-up)**: 처음 켜지면 바로 매매하지 않고 3번 정도 시장 가격만 지켜봅니다. 데이터가 충분히 모일 때까지 기다리는 것입니다.
2.  **쪽지 확인**: 대시보드에서 온 명령(종료, 재시작 등)이 있는지 확인합니다.
3.  **가격 확인**: 업비트나 바이낸스 서버에 "지금 비트코인 얼마야?" 하고 물어봅니다.
4.  **보유 종목 관리 (매도 판단)**:
    *   내가 가진 코인이 목표 수익률(예: 5%)을 넘었나? -> **익절 (이익 실현)**
    *   내가 가진 코인이 너무 많이 떨어졌나(예: -3%)? -> **손절 (손실 방어)**
    *   갑자기 -5% 이상 폭락했나? -> **비상 탈출 (무조건 시장가 매도)**
5.  **신규 종목 탐색 (매수 판단)**:
    *   살 만한 좋은 코인이 있나? -> 전략 두뇌(`Strategy`)에게 물어봅니다.
    *   두뇌가 "사라(BUY)"고 하면 -> 내 지갑에 돈이 있는지 확인하고 주문을 넣습니다.
6.  **잠자기**: 3초 동안 쉽니다. (너무 자주 물어보면 거래소에서 차단당하기 때문입니다.)

### 3.2 전략 모듈 (`trading/strategy.py`) - 로봇의 판단 기준

"언제 살 것인가?"를 결정하는 수학 공식들이 들어있습니다.

#### 대표적인 전략 설명 (쉽게 풀이)

1.  **변동성 돌파 (Volatility Breakout)**:
    *   **원리**: "어제 많이 움직였던 폭만큼 오늘 오르면, 오늘도 계속 오를 것이다"라고 믿는 전략입니다.
    *   **비유**: 달리기 선수가 출발선을 힘차게 박차고 나가면 계속 달릴 것이라고 예상하고 같이 뛰는 것과 같습니다.
    *   **공식**: `오늘 시가 + (어제 최고가 - 어제 최저가) * K` 가격을 넘으면 매수합니다.

2.  **RSI (상대 강도 지수)**:
    *   **원리**: "너무 많이 팔려서 가격이 비정상적으로 싸졌다"고 판단될 때 사는 전략입니다.
    *   **비유**: 백화점 세일 기간에 물건이 너무 싸지면 사람들이 몰려와서 다시 가격이 오를 것을 노리는 것입니다.
    *   **조건**: RSI 숫자가 30 밑으로 떨어지면 "과매도(너무 많이 팔림)" 상태라 보고 매수합니다.

3.  **볼린저 밴드 (Bollinger Bands)**:
    *   **원리**: 가격은 보통 일정한 밴드(띠) 안에서 움직이는데, 이 밴드를 뚫고 올라가면 "뭔가 큰 일이 터졌다(상승 추세)"고 보고 따라 사는 것입니다.

---

## 4. 리스크 관리 (돈을 지키는 방법)

돈을 버는 것보다 잃지 않는 것이 더 중요합니다. `RiskManager`가 하는 일입니다.

### 4.1 자금 관리 (얼마나 살까?)
*   **몰빵 금지**: 내 돈이 100만원이 있어도 한 종목에 100만원을 다 쓰지 않습니다.
*   **설정**: `max_position_size = 0.2`로 설정하면, 한 종목에 최대 20만원(20%)까지만 삽니다. 이렇게 하면 코인 하나가 상장 폐지되어도 내 전 재산은 날아가지 않습니다.

### 4.2 손절과 익절 (언제 팔까?)
*   **익절 (Take Profit)**: 욕심부리지 않고 미리 정한 목표(예: 5%)에 도달하면 기계적으로 팝니다.
*   **손절 (Stop Loss)**: "내가 틀렸다"는 것을 인정하고, 손실이 커지기 전에(예: -3%) 잘라냅니다.
*   **트레일링 스탑 (Trailing Stop)**: 가격이 오르면 손절 기준도 같이 올립니다.
    *   예: 100원에 사서 손절가를 90원으로 잡았는데, 가격이 120원으로 오르면 손절가를 110원으로 올립니다. 나중에 가격이 떨어져도 110원에 팔리니까 이익을 챙길 수 있습니다.

---

## 5. 주요 설정값 설명 (`config/settings.py`)

이 숫자들을 고치면 로봇의 성격이 바뀝니다.

| 설정 이름 | 설명 | 추천값 |
| :--- | :--- | :--- |
| **`initial_capital`** | 로봇한테 "너는 이만큼의 돈이 있다고 생각하고 굴려"라고 알려주는 가상의 자본금입니다. | 실제 통장 잔고보다 약간 적게 |
| **`take_profit_percent`** | **익절률**. "이만큼 벌면 팔아라". 0.05는 5%를 의미합니다. | 단타: 0.02 (2%)<br>스윙: 0.10 (10%) |
| **`stop_loss_percent`** | **손절률**. "이만큼 잃으면 무조건 팔아라". 0으로 두면 로봇이 시장 상황(ATR)을 보고 알아서 정합니다. | 0 (자동) 또는 0.03 (3%) |
| **`k_value`** | **돌파 계수**. 변동성 돌파 전략에서 얼마나 빨리 살지 결정합니다. <br> - 낮으면(0.4): 빨리 사지만 가짜 신호에 속을 수 있음.<br> - 높으면(0.7): 늦게 사지만 확실할 때만 삼. | 0.5 ~ 0.6 |

---

## 6. 고급 기능 (알아두면 좋은 것들)

### 6.1 더스트(Dust) 처리
*   **문제**: 코인을 팔 때 수수료 때문에 0.000001개 같은 찌꺼기가 남아서 "잔액 부족"으로 매도가 안 되는 경우가 있습니다.
*   **해결**: 로봇이 "이건 너무 적은 금액(5000원 미만)이라 못 파네"라고 판단하면, 장부에서 그냥 지워버리거나(업비트), 거래소 기능을 이용해 BNB 코인으로 바꿔버립니다(바이낸스).

### 6.2 OCO 주문 (바이낸스 전용)
*   **기능**: 매수하자마자 "익절 주문"과 "손절 주문"을 동시에 미리 걸어둡니다.
*   **장점**: 로봇이 갑자기 꺼지거나 인터넷이 끊겨도, 거래소 서버에 이미 주문이 들어가 있으므로 안전하게 익절/손절이 됩니다.

### 6.3 슬리피지(Slippage) 감지
*   **상황**: 내가 "100원에 팔아줘" 했는데, 가격이 급락해서 "98원"에 팔리는 현상입니다.
*   **기능**: 로봇이 이걸 감지해서 "어? 생각보다 너무 싸게 팔렸는데?" 하고 경고 메시지를 보내줍니다.