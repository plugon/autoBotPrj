# 💻 소스 코드 상세 가이드

이 문서는 프로젝트를 구성하는 각 소스 파일의 역할과 내부 로직을 개발자 관점에서 상세히 설명합니다.
코드 수정이나 기능 확장을 원하실 때 이 가이드를 참고하세요.

---

## 1. 메인 실행 및 설정 (`root`, `config/`)

### `main.py` (핵심 엔진)
*   **역할**: 봇의 시작점이며, 전체 흐름을 관장하는 지휘자입니다.
*   **주요 기능**:
    *   `AutoTradingBot` 클래스: API 연결, 데이터 수집, 전략 실행, 매매 주문을 총괄합니다.
    *   `monitor_and_trade()`: 주기적으로 실행되며 시장을 감시하고 매매를 수행하는 메인 루프입니다.
    *   `daily_routine()`: 매일 아침 모델 재학습, 전략 최적화 등을 수행하는 정기 작업입니다.
    *   스케줄러(`APScheduler`): 정해진 시간마다 함수를 실행하도록 예약합니다.

### `config/settings.py` (설정 저장소)
*   **역할**: 봇의 모든 설정값을 관리합니다.
*   **주요 내용**:
    *   `TRADING_CONFIG`: 매수 금액, 익절/손절 비율, 레버리지, 타임프레임 등 거래 관련 설정.
    *   `API_CONFIG`: 사용할 거래소(업비트, 바이낸스 등) 활성화 여부.
    *   `.env` 파일 로드: API 키 등 민감한 정보를 환경변수에서 불러옵니다.

---

## 2. API 통신 (`api/`)

### `api/base_api.py`
*   **역할**: 모든 거래소 API가 공통적으로 가져야 할 기능(매수, 매도, 조회 등)을 정의한 추상 클래스(설계도)입니다.

### `api/crypto_api.py`
*   **역할**: 암호화폐 거래소와 실제로 통신하는 코드입니다.
*   **`UpbitAPI`**: `pyupbit` 및 `ccxt`를 사용하여 업비트 시세 조회 및 주문을 처리합니다.
*   **`BinanceAPI`**: 바이낸스 현물/선물 거래를 지원합니다.
    *   `subscribe_websocket()`: 실시간 가격 데이터를 받기 위해 웹소켓을 연결합니다.
    *   `create_oco_order()`: 익절과 손절 주문을 동시에 내는 고급 주문 기능입니다.

---

## 3. 트레이딩 로직 (`trading/`)

### `trading/strategy.py` (두뇌)
*   **역할**: 언제 사고팔지 결정하는 전략(알고리즘)이 들어있습니다.
*   **`TechnicalStrategy`**: 보조지표(RSI, 볼린저밴드, MACD 등)를 계산하여 매매 신호를 만듭니다.
    *   `generate_signal()`: 데이터를 분석하여 BUY(매수), SELL(매도), HOLD(관망) 신호를 반환합니다.
*   **`MLStrategy`**: 머신러닝 모델의 예측 결과를 바탕으로 신호를 만듭니다.

### `trading/portfolio.py` (장부)
*   **역할**: 현재 보유 중인 자산과 매매 기록을 관리합니다.
*   **기능**:
    *   `positions`: 현재 보유 종목과 수량을 저장하는 딕셔너리.
    *   `save_state()` / `load_state()`: 봇이 꺼져도 데이터가 날아가지 않게 JSON 파일로 저장/불러오기 합니다.
    *   `get_statistics()`: 총 자산, 수익률 등을 계산합니다.

### `trading/risk_manager.py` (안전장치)
*   **역할**: 손실을 최소화하고 이익을 확정하는 관리자입니다.
*   **기능**:
    *   `check_exit_conditions()`: 현재 가격이 손절가나 익절가에 도달했는지 확인합니다.
    *   `set_stop_loss()`: 매수 시 변동성(ATR)을 기반으로 적절한 손절가를 계산해 설정합니다.
    *   `check_trailing_stop()`: 가격이 오르면 손절가도 같이 올려서 이익을 보존하는 기능입니다.

---

## 4. 머신러닝 및 유틸리티 (`models/`, `utils/`)

### `models/ml_model.py`
*   **역할**: 과거 데이터를 학습하여 미래 가격을 예측하는 AI 모델입니다.
*   **기능**: LSTM(딥러닝)이나 Random Forest 알고리즘을 사용하여 학습(`train`)하고 예측(`predict`)합니다.

### `utils/report_manager.py`
*   **역할**: 텔레그램 알림을 보내는 담당자입니다.
*   **기능**: 매수/매도 체결 알림, 수익률 리포트, 에러 메시지 등을 텔레그램으로 전송합니다.

### `utils/logger.py`
*   **역할**: 봇의 작동 기록(로그)을 파일과 화면에 출력하는 설정을 담당합니다.

---

## 5. 배포 및 빌드 (`root`)

### `build.py`
*   **역할**: 개발 환경을 자동으로 구축하거나, 실행 파일(.exe)을 만드는 스크립트입니다.
*   **기능**:
    *   가상환경(venv) 자동 생성 및 라이브러리 설치.
    *   `PyInstaller`를 사용하여 소스 코드를 하나의 실행 파일로 변환.

---

## 💡 코드 수정 팁

*   **전략을 바꾸고 싶다면**: `trading/strategy.py`의 `generate_signal` 함수를 수정하세요.
*   **매매 로그 형식을 바꾸고 싶다면**: `main.py`의 `_execute_sell` 또는 `_process_crypto_trading` 내부의 로그 출력 부분을 수정하세요.
*   **텔레그램 메시지를 꾸미고 싶다면**: `utils/report_manager.py`를 수정하세요.
*   **새로운 거래소를 추가하려면**: `api/` 폴더에 새 파일을 만들고 `BaseAPI`를 상속받아 구현한 뒤, `main.py`에 연결하세요.

---

## 6. 데이터 흐름도 (Data Flow)

봇의 주요 동작 과정을 시각화한 흐름도입니다.

```text
[시작] main.py
  │
  ├── 1. 초기화 (Initialize)
  │     ├── .env 설정 로드
  │     ├── API 연결 (Upbit, Binance, etc.)
  │     └── 포트폴리오/장부 로드 (data/*.json)
  │
  ├── 2. 학습 (Train Model)
  │     ├── 과거 데이터 수집
  │     └── 머신러닝 모델 학습 (models/*.pkl)
  │
  └── 3. 메인 루프 (Scheduler) ↻ 반복
        │
        ├── A. 시장 감시 (Monitor)
        │     ├── 실시간 가격/OHLCV 조회 (API)
        │     └── 지표 계산 (RSI, MACD, ATR 등)
        │
        ├── B. 전략 판단 (Strategy)
        │     ├── 매수 신호? (Signal: BUY)
        │     ├── 매도 신호? (Signal: SELL)
        │     └── 리스크 관리 (손절/익절 체크)
        │
        ├── C. 주문 실행 (Execution)
        │     ├── API로 주문 전송 (Buy/Sell)
        │     └── 체결 확인 및 슬리피지 체크
        │
        └── D. 후처리 (Post-process)
              ├── 포트폴리오 파일 저장
              └── 텔레그램 알림 전송
```

---

## 7. 설정 값 튜닝 가이드 (`config/settings.py`)

전략의 성과를 높이기 위해 조정할 수 있는 주요 설정값들의 권장 범위입니다.

### 💰 자금 관리
*   **`initial_capital`**: 봇이 운용할 초기 자본금입니다. (실제 계좌 잔고보다 적게 설정하여 안전하게 운영 가능)
*   **`max_position_size`** (권장: `0.1` ~ `0.3`): 한 종목에 투자할 최대 비중입니다.
    *   `0.1` (10%): 보수적. 분산 투자 효과.
    *   `0.3` (30%): 공격적. 소수 종목 집중.

### 📈 매매 전략 (Crypto)
*   **`take_profit_percent`** (익절):
    *   **스캘핑**: `0.01` ~ `0.03` (1% ~ 3%)
    *   **단기/스윙**: `0.05` ~ `0.10` (5% ~ 10%)
    *   **추세 추종**: `0.15` 이상 (15% 이상, 트레일링 스탑 필수)
*   **`stop_loss_percent`** (손절):
    *   `0`: **ATR 기반 동적 손절** 사용 (권장). 시장 변동성에 맞춰 자동으로 조절됩니다.
    *   `0.02` ~ `0.05`: 고정 손절 사용 시.
*   **`k_value`** (변동성 돌파 계수):
    *   권장 범위: `0.4` ~ `0.7`
    *   낮을수록(`0.4`): 진입이 빠르지만 속임수 신호에 걸릴 확률 증가.
    *   높을수록(`0.7`): 진입이 늦지만 확실한 추세에서만 매매.
*   **`atr_multiplier`** (손절 범위):
    *   권장 범위: `1.5` ~ `3.0`
    *   `2.0` (2N): 터틀 트레이딩의 표준 값.

### ⚙️ 시스템 설정
*   **`check_interval`**: `1` ~ `5`초. 너무 짧으면 API 차단 위험, 너무 길면 체결 기회를 놓침.